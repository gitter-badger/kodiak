(function(){"Use Strict";function n(e,n){if(!e||e===""||t.hasOwnProperty(e))throw"textAngular Error: A unique name is required for a Tool Definition";if(n.display&&(n.display===""||angular.element(n.display).length===0)||!n.display&&!n.buttontext&&!n.iconclass)throw'textAngular Error: Tool Definition for "'+e+'" does not have a valid display/iconclass/buttontext value';t[e]=n}var e=angular.module("textAngular",["ngSanitize"]);e.value("taOptions",{toolbar:[["h1","h2","h3","h4","h5","h6","p","pre","quote"],["bold","italics","underline","ul","ol","redo","undo","clear"],["justifyLeft","justifyCenter","justifyRight"],["html","insertImage","insertLink","unlink"]],classes:{focussed:"focussed",toolbar:"btn-toolbar",toolbarGroup:"btn-group",toolbarButton:"btn btn-default",toolbarButtonActive:"active",disabled:"disabled",textEditor:"form-control",htmlEditor:"form-control"},setup:{textEditorSetup:function(e){},htmlEditorSetup:function(e){}}});var t={};e.constant("taRegisterTool",n);e.value("taTools",t);e.config(["taRegisterTool",function(e){angular.forEach(t,function(e,n){delete t[n]});e("html",{buttontext:"Toggle HTML",action:function(){this.$editor().switchView()},activeState:function(){return this.$editor().showHtml}});var n=function(e){return function(){return this.$editor().queryFormatBlockState(e)}};var r=function(){return this.$editor().wrapSelection("formatBlock","<"+this.name.toUpperCase()+">")};angular.forEach(["h1","h2","h3","h4","h5","h6"],function(t){e(t.toLowerCase(),{buttontext:t.toUpperCase(),action:r,activeState:n(t.toLowerCase())})});e("p",{buttontext:"P",action:function(){return this.$editor().wrapSelection("formatBlock","<P>")},activeState:function(){return this.$editor().queryFormatBlockState("p")}});e("pre",{buttontext:"pre",action:function(){return this.$editor().wrapSelection("formatBlock","<PRE>")},activeState:function(){return this.$editor().queryFormatBlockState("pre")}});e("ul",{iconclass:"fa fa-list-ul",action:function(){return this.$editor().wrapSelection("insertUnorderedList",null)},activeState:function(){return document.queryCommandState("insertUnorderedList")}});e("ol",{iconclass:"fa fa-list-ol",action:function(){return this.$editor().wrapSelection("insertOrderedList",null)},activeState:function(){return document.queryCommandState("insertOrderedList")}});e("quote",{iconclass:"fa fa-quote-right",action:function(){return this.$editor().wrapSelection("formatBlock","<BLOCKQUOTE>")},activeState:function(){return this.$editor().queryFormatBlockState("blockquote")}});e("undo",{iconclass:"fa fa-undo",action:function(){return this.$editor().wrapSelection("undo",null)}});e("redo",{iconclass:"fa fa-repeat",action:function(){return this.$editor().wrapSelection("redo",null)}});e("bold",{iconclass:"fa fa-bold",action:function(){return this.$editor().wrapSelection("bold",null)},activeState:function(){return document.queryCommandState("bold")},commandKeyCode:98});e("justifyLeft",{iconclass:"fa fa-align-left",action:function(){return this.$editor().wrapSelection("justifyLeft",null)},activeState:function(e){var t=false;if(e)t=e.css("text-align")==="left"||e.attr("align")==="left"||e.css("text-align")!=="right"&&e.css("text-align")!=="center"&&!document.queryCommandState("justifyRight")&&!document.queryCommandState("justifyCenter");t=t||document.queryCommandState("justifyLeft");return t}});e("justifyRight",{iconclass:"fa fa-align-right",action:function(){return this.$editor().wrapSelection("justifyRight",null)},activeState:function(e){var t=false;if(e)t=e.css("text-align")==="right";t=t||document.queryCommandState("justifyRight");return t}});e("justifyCenter",{iconclass:"fa fa-align-center",action:function(){return this.$editor().wrapSelection("justifyCenter",null)},activeState:function(e){var t=false;if(e)t=e.css("text-align")==="center";t=t||document.queryCommandState("justifyCenter");return t}});e("italics",{iconclass:"fa fa-italic",action:function(){return this.$editor().wrapSelection("italic",null)},activeState:function(){return document.queryCommandState("italic")},commandKeyCode:105});e("underline",{iconclass:"fa fa-underline",action:function(){return this.$editor().wrapSelection("underline",null)},activeState:function(){return document.queryCommandState("underline")},commandKeyCode:117});e("clear",{iconclass:"fa fa-ban",action:function(){return this.$editor().wrapSelection("removeFormat",null)}});e("insertImage",{iconclass:"fa fa-picture-o",action:function(){var e;e=prompt("Please enter an image URL to insert","http://");if(e!==""&&e!=="http://"){return this.$editor().wrapSelection("insertImage",e)}}});e("insertLink",{iconclass:"fa fa-link",action:function(){var e;e=prompt("Please enter an URL to insert","http://");if(e!==""&&e!=="http://"){return this.$editor().wrapSelection("createLink",e)}},activeState:function(e){if(e)return e[0].tagName==="A";return false}});e("unlink",{iconclass:"fa fa-unlink",action:function(){return this.$editor().wrapSelection("unlink",null)},activeState:function(e){if(e)return e[0].tagName==="A";return false}})}]);e.directive("textAngular",["$compile","$timeout","taOptions","taSanitize","textAngularManager",function(e,t,n,r,i){return{require:"?ngModel",scope:{},restrict:"EA",link:function(r,s,o,u){var a,f,l,c,h,p,d,v,m=Math.floor(Math.random()*1e16),g=o.name?o.name:"textAngularEditor"+m;angular.extend(r,angular.copy(n),{wrapSelection:function(e,t){try{document.execCommand(e,false,t)}catch(n){}r.displayElements.text[0].focus()},showHtml:false});if(o.taFocussedClass)r.classes.focussed=o.taFocussedClass;if(o.taTextEditorClass)r.classes.textEditor=o.taTextEditorClass;if(o.taHtmlEditorClass)r.classes.htmlEditor=o.taHtmlEditorClass;if(o.taTextEditorSetup)r.setup.textEditorSetup=r.$parent.$eval(o.taTextEditorSetup);if(o.taHtmlEditorSetup)r.setup.htmlEditorSetup=r.$parent.$eval(o.taHtmlEditorSetup);d=s[0].innerHTML;s[0].innerHTML="";r.displayElements={forminput:angular.element("<input type='hidden' tabindex='-1' style='display: none;'>"),html:angular.element("<textarea></textarea>"),text:angular.element("<div></div>")};r.setup.htmlEditorSetup(r.displayElements.html);r.setup.textEditorSetup(r.displayElements.text);r.displayElements.html.attr({id:"taHtmlElement","ng-show":"showHtml","ta-bind":"ta-bind","ng-model":"html"});r.displayElements.text.attr({id:"taTextElement",contentEditable:"true","ng-hide":"showHtml","ta-bind":"ta-bind","ng-model":"html"});s.append(r.displayElements.text);s.append(r.displayElements.html);r.displayElements.forminput.attr("name",g);s.append(r.displayElements.forminput);if(o.tabindex){r.displayElements.text.attr("tabindex",o.tabindex);r.displayElements.html.attr("tabindex",o.tabindex)}if(o.placeholder){r.displayElements.text.attr("placeholder",o.placeholder);r.displayElements.html.attr("placeholder",o.placeholder)}if(o.taDisabled){r.displayElements.text.attr("ta-readonly","disabled");r.displayElements.html.attr("ta-readonly","disabled");r.disabled=r.$parent.$eval(o.taDisabled);r.$parent.$watch(o.taDisabled,function(e){r.disabled=e;if(r.disabled){s.addClass(r.classes.disabled)}else{s.removeClass(r.classes.disabled)}})}e(r.displayElements.text)(r);e(r.displayElements.html)(r);s.addClass("ta-root");r.displayElements.text.addClass("ta-text ta-editor "+r.classes.textEditor);r.displayElements.html.addClass("ta-html ta-editor "+r.classes.textEditor);r._actionRunning=false;var y=false;r.startAction=function(){r._actionRunning=true;if(window.rangy&&window.rangy.saveSelection){y=window.rangy.saveSelection();return function(){if(y)window.rangy.restoreSelection(y)}}};r.endAction=function(){r._actionRunning=false;if(y)rangy.removeMarkers(y);y=false;r.updateSelectedStyles();if(!r.showHtml)r.updateTaBindtaTextElement()};h=function(){s.addClass(r.classes.focussed);v.focus()};r.displayElements.html.on("focus",h);r.displayElements.text.on("focus",h);p=function(e){t(function(){if(!r._actionRunning&&document.activeElement!==r.displayElements.html[0]&&document.activeElement!==r.displayElements.text[0]){s.removeClass(r.classes.focussed);v.unfocus();t(function(){s.triggerHandler("blur")},0)}},100);e.preventDefault();return false};r.displayElements.html.on("blur",p);r.displayElements.text.on("blur",p);r.queryFormatBlockState=function(e){return e.toLowerCase()===document.queryCommandValue("formatBlock").toLowerCase()};r.switchView=function(){r.showHtml=!r.showHtml;if(r.showHtml){t(function(){return r.displayElements.html[0].focus()},100)}else{t(function(){return r.displayElements.text[0].focus()},100)}};if(o.ngModel){var b=true;u.$render=function(){if(b){b=false;var e=r.$parent.$eval(o.ngModel);if((e===undefined||e===null)&&d&&d!==""){u.$setViewValue(d)}}r.displayElements.forminput.val(u.$viewValue);if(document.activeElement!==r.displayElements.html[0]&&document.activeElement!==r.displayElements.text[0]){r.html=u.$viewValue||""}}}else{r.displayElements.forminput.val(d);r.html=d}r.$watch("html",function(e,t){if(e!==t){if(o.ngModel)u.$setViewValue(e);r.displayElements.forminput.val(e)}});if(o.taTargetToolbars)v=i.registerEditor(g,r,o.taTargetToolbars.split(","));else{var w=angular.element('<div text-angular-toolbar name="textAngularToolbar'+m+'">');if(o.taToolbar)w.attr("ta-toolbar",o.taToolbar);if(o.taToolbarClass)w.attr("ta-toolbar-class",o.taToolbarClass);if(o.taToolbarGroupClass)w.attr("ta-toolbar-group-class",o.taToolbarGroupClass);if(o.taToolbarButtonClass)w.attr("ta-toolbar-button-class",o.taToolbarButtonClass);if(o.taToolbarActiveButtonClass)w.attr("ta-toolbar-active-button-class",o.taToolbarActiveButtonClass);if(o.taFocussedClass)w.attr("ta-focussed-class",o.taFocussedClass);s.prepend(w);e(w)(r.$parent);v=i.registerEditor(g,r,["textAngularToolbar"+m])}r.$on("$destroy",function(){i.unregisterEditor(g)});r._bUpdateSelectedStyles=false;r.updateSelectedStyles=function(){var e;if(window.rangy&&window.rangy.getSelection&&(e=window.rangy.getSelection().getAllRanges()).length===1&&e[0].commonAncestorContainer.parentNode!==r.displayElements.text[0]){v.updateSelectedStyles(angular.element(e[0].commonAncestorContainer.parentNode))}else v.updateSelectedStyles();if(r._bUpdateSelectedStyles)t(r.updateSelectedStyles,200)};a=function(){if(!r._bUpdateSelectedStyles){r._bUpdateSelectedStyles=true;r.$apply(function(){r.updateSelectedStyles()})}};r.displayElements.html.on("keydown",a);r.displayElements.text.on("keydown",a);f=function(){r._bUpdateSelectedStyles=false};r.displayElements.html.on("keyup",f);r.displayElements.text.on("keyup",f);l=function(e){r.$apply(function(){if(v.sendKeyCommand(e)){if(!r._bUpdateSelectedStyles){r.updateSelectedStyles()}e.preventDefault();return false}})};r.displayElements.html.on("keypress",l);r.displayElements.text.on("keypress",l);c=function(){r._bUpdateSelectedStyles=false;r.$apply(function(){r.updateSelectedStyles()})};r.displayElements.html.on("mouseup",c);r.displayElements.text.on("mouseup",c)}}}]).directive("taBind",["taSanitize","$timeout","taFixChrome",function(e,t,n){return{require:"ngModel",scope:{},link:function(r,i,s,o){var u=i.attr("contenteditable")!==undefined&&i.attr("contenteditable");var a=u||i[0].tagName.toLowerCase()==="textarea"||i[0].tagName.toLowerCase()==="input";var f=false;var l=function(){if(u)return i[0].innerHTML;if(a)return i.val();throw"textAngular Error: attempting to update non-editable taBind"};r.$parent["updateTaBind"+(s.id||"")]=function(){if(!f)o.$setViewValue(l())};if(a){i.on("paste cut",function(){if(!f)t(function(){o.$setViewValue(l())},0)});if(!u){i.on("change blur",function(){if(!f)o.$setViewValue(l())})}else{i.on("keyup",function(){if(!f)o.$setViewValue(l())});i.on("blur",function(){var e=l();if(e===""&&i.attr("placeholder"))i.addClass("placeholder-text");if(!f)o.$setViewValue(l());o.$render()});if(i.attr("placeholder")){i.addClass("placeholder-text");i.on("focus",function(){i.removeClass("placeholder-text");var e=l();if(i.attr("placeholder")&&e===i.attr("placeholder")){i[0].innerHTML=""}o.$render()})}}}var c=function(t){return o.$oldViewValue=e(n(t),o.$oldViewValue)};o.$parsers.push(c);o.$formatters.push(c);o.$render=function(){if(document.activeElement!==i[0]){var e=o.$viewValue||"";if(u){if(e===""&&i.attr("placeholder")&&i.hasClass("placeholder-text"))i[0].innerHTML=i.attr("placeholder");else i[0].innerHTML=e;if(!f)i.find("a").on("click",function(e){e.preventDefault();return false})}else if(i[0].tagName.toLowerCase()!=="textarea"&&i[0].tagName.toLowerCase()!=="input"){i[0].innerHTML=e}else{i.val(e)}}};if(s.taReadonly){f=r.$parent.$eval(s.taReadonly);if(f){if(i[0].tagName.toLowerCase()==="textarea"||i[0].tagName.toLowerCase()==="input"){i.attr("disabled","disabled")}if(i.attr("contenteditable")!==undefined&&i.attr("contenteditable")){i.removeAttr("contenteditable")}}else{if(i[0].tagName.toLowerCase()==="textarea"||i[0].tagName.toLowerCase()==="input"){i.removeAttr("disabled")}else if(u){i.attr("contenteditable","true")}}r.$parent.$watch(s.taReadonly,function(e,t){if(t===e)return;if(e){if(i[0].tagName.toLowerCase()==="textarea"||i[0].tagName.toLowerCase()==="input"){i.attr("disabled","disabled")}if(i.attr("contenteditable")!==undefined&&i.attr("contenteditable")){i.removeAttr("contenteditable")}}else{if(i[0].tagName.toLowerCase()==="textarea"||i[0].tagName.toLowerCase()==="input"){i.removeAttr("disabled")}else if(u){i.attr("contenteditable","true")}}f=e})}}}}]).factory("taFixChrome",function(){var e=function(e){var t=angular.element("<div>"+e+"</div>");var n=angular.element(t).find("span");for(var r=0;r<n.length;r++){var i=angular.element(n[r]);if(i.attr("style")&&i.attr("style").match(/line-height: 1.428571429;|color: inherit; line-height: 1.1;/i)){i.attr("style",i.attr("style").replace(/( |)font-family: inherit;|( |)line-height: 1.428571429;|( |)line-height:1.1;|( |)color: inherit;/ig,""));if(!i.attr("style")||i.attr("style")===""){if(i.next().length>0&&i.next()[0].tagName==="BR")i.next().remove();i.replaceWith(i[0].innerHTML)}}}var s=t[0].innerHTML.replace(/style="[^"]*?(line-height: 1.428571429;|color: inherit; line-height: 1.1;)[^"]*"/ig,"");if(s!==t[0].innerHTML)t[0].innerHTML=s;return t[0].innerHTML};return e}).factory("taSanitize",["$sanitize",function(t){function n(e,t){var r=[];var i=e.children();if(i.length){angular.forEach(i,function(e){r=r.concat(n(angular.element(e),t))})}if(e.attr(t))r.push(e);return r}return function(r,i){var s=angular.element("<div>"+r+"</div>");angular.forEach(n(s,"align"),function(e){e.css("text-align",e.attr("align"));e.removeAttr("align")});r=s[0].innerHTML;var o;try{o=t(r)}catch(u){o=i||""}return o}}]).directive("textAngularToolbar",["$compile","textAngularManager","taOptions","taTools","taToolExecuteAction",function(e,t,n,r,i){return{scope:{name:"@"},restrict:"EA",link:function(s,o,u){if(!s.name||s.name==="")throw"textAngular Error: A toolbar requires a name";angular.extend(s,angular.copy(n));if(u.taToolbar)s.toolbar=s.$parent.$eval(u.taToolbar);if(u.taToolbarClass)s.classes.toolbar=u.taToolbarClass;if(u.taToolbarGroupClass)s.classes.toolbarGroup=u.taToolbarGroupClass;if(u.taToolbarButtonClass)s.classes.toolbarButton=u.taToolbarButtonClass;if(u.taToolbarActiveButtonClass)s.classes.toolbarButtonActive=u.taToolbarActiveButtonClass;if(u.taFocussedClass)s.classes.focussed=u.taFocussedClass;s.disabled=true;s.focussed=false;o[0].innerHTML="";o.addClass("ta-toolbar "+s.classes.toolbar);s.$watch("focussed",function(){if(s.focussed)o.addClass(s.classes.focussed);else o.removeClass(s.classes.focussed)});setupToolElement=function(t,n){var r;if(t&&t.display){r=angular.element(t.display)}else r=angular.element("<button type='button'>");r.addClass(s.classes.toolbarButton);r.attr("name",n.name);r.attr("unselectable","on");r.attr("ng-disabled","isDisabled()");r.attr("tabindex","-1");r.attr("ng-click","executeAction()");r.attr("ng-class","displayActiveToolClass(active)");r.on("mousedown",function(e){e.preventDefault();return false});if(t&&!t.display&&!n._display){r[0].innerHTML="";if(t.buttontext)r[0].innerHTML=t.buttontext;if(t.iconclass){var i=angular.element("<i>"),o=r[0].innerHTML;i.addClass(t.iconclass);r[0].innerHTML="";r.append(i);if(o&&o!=="")r.append("&nbsp;"+o)}}n._lastToolDefinition=angular.copy(t);return e(r)(n)};s.tools={};s._parent={disabled:true,showHtml:false,queryFormatBlockState:function(){return false}};var a={$editor:function(){return s._parent},isDisabled:function(){return this.$eval("disabled")||this.$eval("disabled()")||this.name!=="html"&&this.$editor().showHtml||this.$parent.disabled||this.$editor().disabled},displayActiveToolClass:function(e){return e?s.classes.toolbarButtonActive:""},executeAction:i};angular.forEach(s.toolbar,function(e){groupElement=angular.element("<div>");groupElement.addClass(s.classes.toolbarGroup);angular.forEach(e,function(e){s.tools[e]=angular.extend(s.$new(true),r[e],a,{name:e});s.tools[e].$element=setupToolElement(r[e],s.tools[e]);groupElement.append(s.tools[e].$element)});o.append(groupElement)});s.updateToolDisplay=function(e,t,n){var r=s.tools[e];if(r){if(r._lastToolDefinition&&!n)t=angular.extend({},r._lastToolDefinition,t);if(t.buttontext===null&&t.iconclass===null&&t.display===null)throw'textAngular Error: Tool Definition for updating "'+e+'" does not have a valid display/iconclass/buttontext value';if(t.buttontext===null){delete t.buttontext}if(t.iconclass===null){delete t.iconclass}if(t.display===null){delete t.display}toolElement=setupToolElement(t,r);r.$element.replaceWith(toolElement);r.$element=toolElement}};t.registerToolbar(s);s.$on("$destroy",function(){t.unregisterToolbar(s.name)})}}}]).service("taToolExecuteAction",["$q",function(e){return function(t){if(t!==undefined)this.$editor=function(){return t};var n=e.defer(),r=n.promise,i=this.$editor();r["finally"](function(){i.endAction.call(i)});var s;try{s=this.action(n,i.startAction())}catch(o){}if(s||s===undefined){n.resolve()}}}]).service("textAngularManager",["taToolExecuteAction",function(e){var n={},r={};return{registerEditor:function(i,s,o){if(!i||i==="")throw"textAngular Error: An editor requires a name";if(!s)throw"textAngular Error: An editor requires a scope";if(r[i])throw'textAngular Error: An Editor with name "'+i+'" already exists';var u=[];angular.forEach(o,function(e){if(n[e])u.push(n[e])});r[i]={scope:s,toolbars:o,_registerToolbar:function(e){if(this.toolbars.indexOf(e.name)>=0)u.push(e)},editorFunctions:{disable:function(){angular.forEach(u,function(e){e.disabled=true})},enable:function(){angular.forEach(u,function(e){e.disabled=false})},focus:function(){angular.forEach(u,function(e){e._parent=s;e.disabled=false;e.focussed=true})},unfocus:function(){angular.forEach(u,function(e){e.disabled=true;e.focussed=false})},updateSelectedStyles:function(e){angular.forEach(u,function(t){angular.forEach(t.tools,function(t){if(t.activeState){t.active=t.activeState(e)}})})},sendKeyCommand:function(n){var r=false;if(n.ctrlKey||n.metaKey)angular.forEach(t,function(t,i){if(t.commandKeyCode&&t.commandKeyCode===n.which){for(var o=0;o<u.length;o++){if(u[o].tools[i]!==undefined){e.call(u[o].tools[i],s);r=true;break}}}});return r}}};return r[i].editorFunctions},retrieveEditor:function(e){return r[e]},unregisterEditor:function(e){delete r[e]},registerToolbar:function(e){if(!e)throw"textAngular Error: A toolbar requires a scope";if(!e.name||e.name==="")throw"textAngular Error: A toolbar requires a name";if(n[e.name])throw'textAngular Error: A toolbar with name "'+e.name+'" already exists';n[e.name]=e;angular.forEach(r,function(t){t._registerToolbar(e)})},retrieveToolbar:function(e){return n[e]},retrieveToolbarsViaEditor:function(e){var t=[],n=this;angular.forEach(this.retrieveEditor(e).toolbars,function(e){t.push(n.retrieveToolbar(e))});return t},unregisterToolbar:function(e){delete n[e]},updateToolsDisplay:function(e){var t=this;angular.forEach(e,function(e,n){t.updateToolDisplay(n,e)})},resetToolsDisplay:function(){var e=this;angular.forEach(t,function(t,n){e.resetToolDisplay(n)})},updateToolDisplay:function(e,t){var r=this;angular.forEach(n,function(n,i){r.updateToolbarToolDisplay(i,e,t)})},resetToolDisplay:function(e){var t=this;angular.forEach(n,function(n,r){t.resetToolbarToolDisplay(r,e)})},updateToolbarToolDisplay:function(e,t,r){if(n[e])n[e].updateToolDisplay(t,r);else throw'textAngular Error: No Toolbar with name "'+e+'" exists'},resetToolbarToolDisplay:function(e,r){if(n[e])n[e].updateToolDisplay(r,t[r],true);else throw'textAngular Error: No Toolbar with name "'+e+'" exists'},refreshEditor:function(e){if(r[e]){r[e].scope.updateTaBindtaTextElement();if(!r[e].scope.$$phase)r[e].scope.$digest()}else throw'textAngular Error: No Editor with name "'+e+'" exists'}}}])})()